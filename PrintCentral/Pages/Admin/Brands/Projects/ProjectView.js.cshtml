@page
@inject ILocalizationService g
@inject IUserData userData
@{
	Layout = null;
}
//# sourceURL=https://Pages/Admin/Brands/Projects/ProjectView.js
/// <reference path="/js/jquery-3.0.0.min.js" />
/// <reference path="/js/Kendo.all.min.js" />
/// <reference path="/js/AppContext.js" />
// avoid arrow functions for backward compatibility
//<script>
    var ProjectView = function (projectid, companyid, brandid) {
        this.ProjectID = projectid;
        this.CompanyID = companyid;
        this.BrandId = brandid;

        this.WorkflowConfig;
        //this.CustomerList = ["CustomerSupport", "ClientContact"];
        FormView.Extend(this, "@g["Project"]", `/Admin/Brands/Projects/ProjectView?projectid=${projectid}&companyid=${companyid}`);
    };


    ProjectView.prototype = {
        constructor: ProjectView,

		@if (userData.Admin_Projects_CanEditFTPSettings)
		{
		<text>
        FtpFolderChanged: function (e) {

            let self = this;

            if (self.model.EnableFTPFolder) {

                AppContext.Brands.GetByID(self.BrandId, (brand) => {
				    // brand folder is required to set project folder ftp
					if (!brand.EnableFTPFolder)
						AppContext.ShowError("@g["Cannot define a folder for this Project"]");
					else
						this.elements.FTPFolder.prop('readonly', false);
				
			    });

            } else {
                this.elements.FTPFolder.prop('readonly', true);
            }
        },

		</text>
		}

		@if (userData.Admin_Projects_CanEditRFIDSettings)
		{
		<text>
		RFIDConfig: function (e) {
			var self = this;
			AppContext.LoadJS("/Admin/RfidConfig/RfidConfigView.js").then(() => {
				var view = new RfidConfigView(self.model.RFIDConfigID);
				view.ShowDialog((data) => {
					if (data != null) {
						self.model.RFIDConfigID = data.ID;
						if (self.model.ID != null && self.model.ID != 0)
							AppContext.Projects.AssignRFIDConfig(self.model.ID, data.ID);
					}
				}, "60%");
			});
		},
		OrderWorkflowConfig: function (e) {
			var self = this;
			AppContext.LoadJS("/Admin/OrderWorkflowConfig/OrderWorkflowConfigView.js").then(() => {
				var view = new OrderWorkflowConfigView(self.model.OrderWorkflowConfigID);
				view.ShowDialog((data) => {
					if (data != null) {
						self.model.OrderWorkflowConfigID = data.ID;
						if (self.model.ID != null && self.model.ID != 0)
							AppContext.Projects.AssignOrderWorkflowConfig(self.model.ID, data.ID);
					}
				}, "60%");
			});
		},
		</text>
		}

		@if (userData.Admin_Projects_CanEdit)
		{
		<text>
        Save: function (e) {
			let self = this;
			if (!this.model.ValidState()) return;
            let data = this.GetData();
            data.FTPClients = JSON.stringify(this.elements.FTPClientsGrid.Rows.DataSource);
            AppContext.Projects.Update(data, function (result) {
				if (result.Success) {
					self.OnSaved.Raise(data);
					if (self.dialog === true)
						self.Close(data);
				}
			});
        },

        FlowConfig: function () {
            let self = this;
        },


        EnableValidationWorkflow: function () {
            var self = this;

            if (self.model.EnableValidationWorkflow) {
                self.elements.btn_ValidationConfig
                    .prop('disabled', false)
                    .removeClass('disabled')
            } else {
                self.elements.btn_ValidationConfig
                    .prop('disabled', true)
                    .addClass('disabled')
            }
        },

        ValidationConfig: function () {
            let self = this;
            
            AppContext.LoadJS("/Admin/Brands/Projects/WorkflowConfig/WorkflowConfigView.js").then(function () {
                let currentConfig = self.model.GetData();

                self.WorkflowConfig = new WorflowConfigView(currentConfig);

                self.WorkflowConfig.ShowDialog(function (newConfig) {
                    if (!newConfig) {
                        // cannot get config data
                        return;
                    }

                    let currentData = self.model.GetData();
                    let newData = $.extend({}, currentData, newConfig);
                    self.LoadData(newData);

                })


            });

        },

		</text>
		}

		OnLoad: function () {
            let self = this;
            let grid = this.elements.FTPClientsGrid;
            grid.Rows.BeforeSelectedChanged.Subscribe(this, (e) => {
                this.SaveRow(e.rowIndex, e.rowData);
            });
			
            let p = AppContext.Projects.GetByID(self.ProjectID);

            p.done((result) => {

                self.LoadData(result);
                
                if (this.model.FTPClients) {
                    this.elements.FTPClientsGrid.Rows.LoadData(JSON.parse(this.model.FTPClients));
                }
            });

        },

        AddFtpClient: function (e) {
			e.preventDefault();
            this.elements.FTPClientsGrid.Rows.Add({ Server: "" });
        },

        RemoveFtpClient: function () {
			let self = this;
            let idx = this.elements.FTPClientsGrid.Rows.SelectedIndex;
			if (idx >= 0) {
				var confirm = new ConfirmDialog("@g["Delete selected FTP client from this Project?"]");
				confirm.ShowDialog(function (response) {
					if (response) {
                        self.elements.FTPClientsGrid.Rows.Remove(idx);
					}
				});
			}
		},

        SaveRow: function (rowIndex, rowData) {
			return new Promise((resolve, reject) => {
				if (rowIndex >= 0) {
                    let grid = this.elements.FTPClientsGrid;
					if (grid.Rows.IsEdited(rowIndex) || rowData.ID == 0) {
						grid.Rows.IsEdited(rowIndex, false);
                        grid.Rows.Update(rowIndex, rowData);
						resolve();
					}
					else resolve();
				} else resolve();
			});
        },

        DefineCustomReport: function () {
            let self = this;
            let options = {
                ProjectID: self.ProjectID,
                FieldsConfig: self.model.CustomOrderDataReport
            };

            AppContext.LoadJS('/Admin/Brands/Projects/CustomFieldsReport/DefineCustomFields.js').then(() => {
                self.DefineCustomFields = new DefineCustomFields(options);

                self.DefineCustomFields.ShowDialog((dialogData) => {

                    if (!dialogData) return;

                    self.model.CustomOrderDataReport = dialogData;
                    // get dialog data and inject into the form

                }, '80%');
            });
        },

        @if(userData.IsSysAdmin == true)
        {
		<text>
        SageImports: function () {
            let self = this;

            AppContext.LoadJS('/Admin/Brands/Projects/Sage/InitialsImportsView.js').then(() => {

                let view = new InitialsImportsView({ ProjectID: self.model.ID });

                view.ShowDialog(null, '80%');
            });
        },

		</text>
        }
	};
//</script>