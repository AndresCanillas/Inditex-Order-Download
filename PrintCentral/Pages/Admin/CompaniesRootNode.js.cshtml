@page
@inject ILocalizationService g
@inject IUserData userData
@{
	Layout = null;
}
//# sourceURL=https://Pages/Admin/CompaniesRootNode.js
/// <reference path="/js/jquery-3.0.0.min.js" />
/// <reference path="/js/Kendo.all.min.js" />
/// <reference path="/js/AppContext.js" />

//<script>
	var CompaniesRootNode = function () {
		TreeNode.Extend(this, "CompaniesRootNode", 0, "@g["Companies"]");
		this.CanEdit = false;
		@if (userData.Admin_Companies_CanAdd)
		{
		<text>
		this.menu = {
			MenuWidth: "200px",
			Options: [
				{ Text: "@Html.Raw(g["New Company"])", OnClick: this.CreateCompany }
			]
		};
		</text>
		}
	};


	CompaniesRootNode.prototype = {
		constructor: CompaniesRootNode,

		loadDependencies: function (callback) {
			AppContext.LoadJS(
				"/Admin/CompanyNode.js",
				"/Common/AskNameDialog.js").then(()=>callback());
		},

		@if (userData.Admin_Companies_CanAdd)
		{
		<text>
		GetContextMenu: function () {
			return this.menu;
		},

		CreateCompany: function () {
			var self = this;
			this.loadDependencies(function () {
				var dialog = new AskNameDialog("@g["New Company"]");
				dialog.ShowDialog(function (dlgData) {
					if (!dlgData) return;
					dlgData.ShowAsCompany = true;
					AppContext.Companies.Insert(dlgData, function (result) {
						if (result.Success) {
							var node = new CompanyNode(result.Data);
							self.AddNode(node);
							node.OnDoubleClick();
							if (!self.Expanded)
								self.Expand();
						}
					});
				});
			});
		},
		</text>
		}

		OnExpanded: function () {
			var self = this;
			this.loadDependencies(function () {
				if (!self.IsLoaded) {
					self.IsLoaded = true;
					AppContext.Companies.GetList(function (data) { self.loadNodes(data); });
				}
			});
		},

		loadNodes: function (data) {
			var company, node;
			for (var index = 0; index < data.length; index++) {
				company = data[index];
				if (!this.FindNode("CompanyNode", company.ID, false)) {
					node = new CompanyNode(company);
                    if (company.Name.toLowerCase() == "smartdots" || company.ID == 1)
						this.AddNode(node, true);
					else
						this.AddNode(node, false);
				}
			}
		}
	};
//</script>

