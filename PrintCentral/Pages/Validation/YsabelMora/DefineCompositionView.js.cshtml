@page
@inject ILocalizationService g
@inject IUserData userData
@inject IAppConfig config

@using WebLink.Contracts.Models
@{
    Layout = null;

    var lang = CultureInfo.CurrentUICulture.Name;
}
//# sourceURL=https://Pages/Validation/YsabelMoral/DefineCompositionView.js
/// <script>
/**
    *
    * @@param options
    */
/*
Object options {
    OrderID: INT
    ProjectID : INT,
    CompositionDefined: {
        Sections: [],
        CareInstructions:[]
    },

    OrderSelection: {
        OrderGroupID: 1,
        OrderNumber: '8545',
        Details: [],
        Orders:
        [OrderId, OrderID, ....],
        WizardStepPosition: 0 ,
        ProjectID: INT
    }
}
    */
var DefineCompositionView = function (options, projectData) {
    // set default settings here

    let maxFibers = 5;
    let maxSections = 12;
    let forceCiSelection = true;

    options = $.extend({
        Title: options.Label.ShoeComposition ? '@g["Footwear Composition"]' : '@g["Garment Composition"]',
        //ViewUrl: '@Url.Content("~/Validation/YsabelMora/DefineCompositionView")',

        UserLang: '@lang',
        Languages: [{ "Culture": "en-US", "Lang": "English", "APICode": "en" }, { "Culture": "fr-FR", "Lang": "French" }, { "Culture": "es-ES", "Lang": "Spanish" }],

        ConfirmCloseWindowText: '@g["You will lose any unsaved changes, are you sure to close ?"]',
        ConfirmButtonText: '@g["Confirm"]',
        WarningRemoveSectionText: '@g["Section will removed, this action can't undo.Please confirm this action"]',
        LeatherText: '@g["Leather"]',
        TextileText: '@g["Textile"]',
        SyntheticText: '@Html.Raw(g["Synthetic"])', // Html.Raw(g["Synthetic"])
        DefaultOptionText: '@Html.Raw(g["Select an Option"])', // @Html.Raw(g["Select an Option"])
        Shoes3SectionsOptionsText: '@Html.Raw(g["Shoes 3 Sections"])',
        Shoes2SectionsOptionsText: '@Html.Raw(g["Shoes 2 Sections"])',
        GenericOptionText: '@g["Generic"]',
        CompoForMexicoOptionText: '@Html.Raw(g["Composition Mexico"])',
        SectionLabelText: '@g["Section"]',
        FiberTypesPlaceHolderText: '@g["Fiber Type"]',
        CountryOfOriginLabelText: '@g["Origin"]',
        FiberLabelText: '@g["Fiber"]',
        AddFiberActionText: '@g["Add Fiber"]',
        IsBlankFieldText: '@g["Without Fibers"]',
        IsMainTitleText: '@g["Main Title"]',
        ErrorToLoadCareInstructionsText: '@g["Fail to get care instructions data"]',
        ErrorToLoadTemplatesData: '@g["Error trying get Templates data."]',
        UserErrorSectionsRepeat: '@g["Sections cannot be repeated"]',
        UserErrorFibersMinWeigth: '@g["All fibers must have more than 0 percent"]',
        UserErrorFiberRepeat: '@g["Cannot repeat a fiber within a section"]',
        UserErrorFibersMaxWeigth: '@g["All fibers on a section together must add up to 100 percent"]',
        UserErrorCountryOfOriginRequired: '@g["Country is required for Leather Fiber Type"]',
        UserErrorFiberTypeRequired: '@g["Fiber Type is Required"]',
        UserErrorFibersAndSectionsAreNotCompleted: '@g["Please complete the sections and fibers"]',
        UserErrorCareInstructionsRequired: '@g["Please select all Care Instrucctions"]',


        // proyect configuration dependency
        MaxFibers: maxFibers,
        MaxSections: maxSections,
        WrSymbolCssClass: 'common-wr-symbol',
        SectionCatalogName: '@Catalog.BRAND_SECTIONS_CATALOG',
        FibersCatalogName: '@Catalog.BRAND_FIBERS_CATALOG',
        WashingRulesCatalogName: '@Catalog.BRAND_CAREINSTRUCTIONS_CATALOG',
        TemplateCatalogs: '@Catalog.BRAND_CAREINSTRUCTIONS_TEMPLATES_CATALOG',
        ProjectData: projectData,
        ForceToSelectWrOption: forceCiSelection,
        ShoesSectionConfig: [{
            Code: '00',
            Sort: 0
        }, {
            Code: '00',
            Sort: 1
        }, {
            Code: '00',
            Sort: 2
        }]


    }, options);

    ADefineCompositionView.Extend(this, options)
    ExtendObj(this, DefineCompositionView.prototype);// override base class methods - uggly version, but simple
}


DefineCompositionView.prototype = {
    constructor: DefineCompositionView,

    OnLoad: async function () {

        var self = this;

        self.elements.Title.html(this.options.Title);

        self.LoadCompoOptions();

        //Load Shoes Composition catalogs
        if (self.ProjectData.EnableShoeComposition)
            await self.LoadShoeCompoCatalogs();

        await self.LoadCareInstructions();

        self.LoadCatalogs().done(() => {

            self.LoadOrderData();

            self.EnableEvents = true;

            self.elements['TargetArticle'].change(); // fire change event

            self.elements['WrTemplate'].change();;// fire change event

            self.InitialData = $(self.FormSelector).serializeArray();

        });/*.fail((a,b,c) => { console.log(a,b,c) })*/

        self.JavascriptUIEvents();
    },


    SetCareSymbols: AppContext.EmptyFn,

    FilterElements: function (e) {

        let self = this;
        
        if (!self.EnableEvents) return;

        let id = parseInt(e.target.value);

        //clear invalid class
        $("input[name*='Instruction_input']").parent().removeClass("comboArticlesNull");

        if (id > 0) {
            self.LoadTemplateCategories(id);

            // set custom image for care instructions symbols
            let userSelection = self.TemplatesData.find(f => f.ID == id);
            let imgSymbolsYMO = userSelection.SymbolsImage;
            let timeMark = AppContext.GetSettings() ? AppContext.GetSettings().timeMark : '';
            let img = new Image();
            img.src = `/images/getimage/${self.options.ProjectData.ID}/${imgSymbolsYMO}.png?${timeMark}`;
            img.width = '196';
            img.height = '58';
            img.alt = userSelection.Name;
            self.elements['wsymbols'].html(img)
             
        } else {

            // CITemplateConfig.Forced = 2
            if (self.ProjectData.TemplateConfiguration == 2) {
                self.ClearCareInstructionsCombo();
            } else {
                self.LoadCategories();
                self.SetCareSymbols();
            }

        }
    }
}

/// </script>

