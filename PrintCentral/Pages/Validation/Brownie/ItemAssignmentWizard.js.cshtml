@page
@inject ILocalizationService g
@inject IUserData userData
@inject IOrderRepository orderRepo
@inject IProjectRepository projectRepo
@inject IEventQueue events
@{
    Layout = null;


}
//# sourceURL=https://Pages/Validation/Brownie/ItemAssignmentWizard.js
/// <script>


    var ItemAssignmentWizard = function (orderSelection, wizardStep, allSteps) {

        this.OrderSelection = orderSelection;
        this.WizardStep = wizardStep;
        this.AllSteps = allSteps;
        this.BreadCrumbs = null;
        //this.OrderGroups = [];
        this.ArticleList = {};
        this.ArticleSelected = [];
        this.ProjectIDList = [];
        this.ComponentBaseName = "ArticleSelection_";
        this.Catalogs = []; // [{ Definition:'', Name:'', Data: [] }, { Definition:'', Name:'', Data: [] }]
        this.Project = {};
        this.PackList = {}
        let self = this;

        AWizardBaseView.Extend(this, "@g["Assign Items"]", `@Url.Content("~/Validation/Brownie/ItemAssignmentWizard")?n=${self.OrderSelection.length}&ProjectID=${self.OrderSelection[0].ProjectID}`, wizardStep, allSteps);
        ExtendObj(this, ItemAssignmentWizard.prototype); // override base class methods - uggly version, but simple
    }

    ItemAssignmentWizard.prototype = {

        constructor: ItemAssignmentWizard,

        OnLoad: async function () {

            var self = this;

            self.ShowStatus();
            await self.LoadServerData();
            await self.LoadPacks();
            self.InitializeComponents();

            //this.elements.Images.ItemSelected.Subscribe(this, this.OpenItem);

            //self.CreateNewCard();
        },

        InitializeComponents: function () {
            let self = this;

            self.OrderSelection.forEach((sel, idx, arr) => {

                let cmp = self.elements[self.ComponentBaseName + idx];
                
                let labels = self.ArticleList[sel.ProjectID.toString()].filter(article => article.LabelID > 0)
                let items = self.ArticleList[sel.ProjectID.toString()].filter(article => article.LabelID == null)
                let itemsPacks = self.PackList[sel.ProjectID.toString()]

                cmp.Initialize(sel, labels, items, self.Catalogs, self.Project );

                /*if (itemsPacks && itemsPacks.length > 0) {
                    cmp.InitializePacks(sel, itemsPacks)
                }*/

            });
        },
        LoadServerData: async function () {
            var self = this;
            await self.LoadArticles();
            await self.LoadCatalogs();
            await self.LoadProject();
        },

        LoadArticles: async function () {

            let self = this;

            let projectsIDs = []

            self.OrderSelection.forEach((sel, idx, arr) => {

                projectsIDs.push(sel.ProjectID)

            });

            self.ProjectIDList = [...new Set(projectsIDs)];
            //let uniqueProjectsIDs = [59,81,102,127] // testing

            // Sample execute multiple ajax request asyn way
            // this cases never happened because
            // wizard validation only allow validate multiple orders only belong to the same projectID
            await Promise.all(self.ProjectIDList.map(async (i) => {

                return await AppContext.Articles.GetFullByProjectIDFiltered({
                    ProjectID: parseInt(i),
                    ArticleType: 1
                }).then((result) => {
                    self.ArticleList[i.toString()] = result;
                })
                //var articles = await AppContext.Articles.GetFullByProjectIDFiltered({ ProjectID: parseInt(self.ProjectID), ArticleType: 1 });
                //self.ArticleList[i.toString()] = articles;
                //console.log('Project ' + i);
            })).then(self.ArticlesLoadedOK, self.ArticlesCantLoad)

        },

        LoadPacks: async function () {

            let self = this
            let projectsIDs = []

            self.OrderSelection.forEach((sel, idx, arr) => {

                projectsIDs.push(sel.ProjectID)
            });

            self.ProjectIDList = [...new Set(projectsIDs)]
            await Promise.all(self.ProjectIDList.map(async (i) => {
                return await AppContext.Packs.GetByProjectID(parseInt(i)).then((result) => {
                    self.PackList[i.toString()] = result;
                })
            })).then(self.PacksLoadedOK, self.PacksCantLoad)

        },

        LoadProject: async function () {
            let self = this;

            await AppContext.Projects.GetByID(self.OrderSelection[0].ProjectID).then((result) => {
                self.Project = result;
            })
        },

        GetRequiredCatalogs: function () {
            return ['@Catalog.BRAND_MADEIN_CATALOG']
        },

        Save: function () {

            let self = this;

            let deffered = $.Deferred();

            if (!self.model.ValidState() || !self.CompleteOrderSelection()) {

                deffered.reject();

                return deffered.promise();
            };

            let promise = AppContext.Wizard.SaveAssigmentItems({
                selection: self.OrderSelection,
                productfields: []
            })
                .then((rq) => {

                    AppContext.Wizard.GetOrdersDataAssigment(self.OrderSelection).done((result) => {
                        self._UpdateSelection(result)
                    });

                    AppContext.ShowSuccess("@g[" State Saved "]");
                })

            return promise;

        },

        _solve: function () {
            let self = this;

            let deffered = $.Deferred();

            let componentsAreValid = self.CompleteOrderSelection();

            if (!componentsAreValid) {

                deffered.reject();

                return deffered.promise();
            };

            let promise = AppContext.Wizard.SolveAssigmentItems({
                Selection: self.OrderSelection,
                ProductFields: [],
                GetAllArticles: true
            })
                .then((result) => {
                    self._UpdateSelection({
                        Data: {
                            OrderData: result.Data
                        }
                    })
                })

            return promise;

        },

        SaveAndNext: function () {

            var self = this;

            if (!self.ComponentsValidation()) {
                AppContext.ShowError("@g[" You must add at least 1 item to continue "]");
                return;
            }

            var p = self._solve();

            p.done(() => {

                self.GetValidator().GetStep(self.WizardStep.Position + 1);

            })

        },

        CompleteOrderSelection() {
            let self = this;

            let isValid = true;

            self.OrderSelection.forEach((sel, idx, arr) => {

                let cmp = self.elements[self.ComponentBaseName + idx];

                if (!cmp.IsValid()) {

                    isValid = false;

                    return true; // continue with next
                }

                if (isValid) {
                    sel.SelectedArticles = cmp.GetSelectedArticles();

                    sel.ProductFields = cmp.GetProductFields();
                }

            });

            return isValid;
        },

        _UpdateSelection: function (result) {

            var self = this;

            for (var i = 0; i < result.Data.OrderData.length; i++) {

                var sel = result.Data.OrderData[i]

                for (var j = 0; j < sel.Orders.length; j++) {
                    self.OrderSelection[i].Orders.push(sel.Orders[j])
                }

                self.OrderSelection[i].Orders = [...new Set(self.OrderSelection[i].Orders)];
            }

        },

        ComponentsValidation: function () {
            var self = this;
            var flag = true;

            self.OrderSelection.every((sel, idx, arr) => {

                let cmp = self.elements[self.ComponentBaseName + idx];

                if (!cmp.HasItems()) {
                    flag = false;
                    return;
                }
                return;
            });

            return flag;

        },

        /// #region Articles Handlers
        // this is use like promise function, the arguments alwasy be: promise1, promise2,... promiseN
        ArticlesLoadedOK: function () {

            // all articles are loaded ok
        },

        ArticlesCantLoad: function () {
            console.log('ArticlesCantLoad');
        },

        /// #endregion Article Handlers


        /// #region Packs Handlers
        PacksLoadedOK: function () {

            // all packs are loaded ok
        },

        PacksCantLoad: function (e) {
            console.log('PacksCantLoad');
        }

        /// #endregion Packs Handlers


    };


/// </script>

