@page
@inject ILocalizationService g
@inject IUserData userData
@{
	Layout = null;
}
//# sourceURL=https://Pages/Common/Components/LabelsListView.js
/// <reference path="/js/jquery-3.0.0.min.js" />
/// <reference path="/js/Kendo.all.min.js" />
/// <reference path="/js/AppContext.js" />

//<script>
    var LabelsListView = function () {
		FormView.Extend(this);
		this.Content = $(`
			<inlineform name="FilterForm" style="display:none; margin-bottom:10px;">
				<select model name="LabelType" label="@g["Label Type"]:" action="change:ApplyFilters" style="max-width:200px;">
					<option value="1">@g["All"]</option>
					<option value="2">@g["Shared"]</option>
					<option selected value="3">@g["Custom"]</option>
				</select>
				<input model name="SearchText" label="@g["Search"]:" action="keyup:ApplyFilters" />
			</inlineform>
			<div name="ListContainer"></div>`);
		this.dataSource = null;
		this.ItemSelected = new AppEvent();
	};

	LabelsListView.prototype = {
        constructor: LabelsListView,

		OnLoad: function () {
			AppContext.AppEventListener.Subscribe(this, this.HandleNotifications);
		},

		OnUnload: function () {
			AppContext.AppEventListener.Unsubscribe(this, this.HandleNotifications);
			this.ItemSelected.Dispose();
		},

		HandleNotifications: function (e) {
			if (e.EventName === "EntityEvent") {
				if (e.EntityName === "LabelData") {
					if(e.Operation === 2)
						this.HandleDeleteNotification(e.Entity);
					if (e.Operation === 1)
						this.HandleUpdateNotification(e.Entity);
				}
			}
		},

		HandleDeleteNotification(entity) {
			var card = this.ViewContainer.find(`[data-entityid='${entity.ID}']`);
			if (card.length === 1) {
				card.off();
				card.remove();
			}
		},

		HandleUpdateNotification(entity) {
			this.UpdateCard(entity);
		},

		ApplyFilters: function (e) {
			var self = this;
			var cards = this.elements.ListContainer.find("[data-entityid]");
			$.each(cards, function (index, card) {
				card = $(card);
				var visible = true;
				var badge = card.find("span[name='SHFlag']");
				var isShared = badge.hasClass("badge-warning");
				switch (self.model.LabelType) {
					case "1": break;
					case "2": visible = visible && isShared; break;
					case "3": visible = visible && !isShared; break;
				}

				var searchText = self.model.SearchText;
				if (searchText != null && searchText.length > 0) {
					var name = card.find('[name="Name"]').text();
					var comments = card.find('[name="Comments"]').text();
					var rgx = new RegExp(`${searchText}`, 'gi');
					visible = visible && (rgx.test(name) || rgx.test(comments));
				}

				if (visible)
					card.show();
				else
					card.hide();
			});
		},

		LoadItems: function (setup) {
			if (setup == null) setup = { ProjectID: 0 };
			if (setup.ProjectID == null)
				setup.ProjectID = 0;
			this.ProjectID = setup.ProjectID;
			this.ShowFilters = setup.ShowFilters == true;
			this.ShowNewOption = setup.AddOption == true;
			this.ShowOpenOption = setup.OpenOption == true;
			this.ShowDeleteOption = setup.DeleteOption == true;
			if (this.ShowFilters)
				this.elements.FilterForm.show();
			else
				this.elements.FilterForm.hide();
			var self = this;
            AppContext.Labels.GetByProjectID(this.ProjectID, function(data) {
                self.dataSource = data;
				self.elements.ListContainer.empty();
				@if (userData.Admin_Labels_CanAdd)
				{
					@:if(self.ShowNewOption) self.CreateNewCard();
				}
				if (data != null) {
					for (var i = 0; i < data.length; i++) {
						self.CreateItemCard(data[i]);
					}
				}
				self.ApplyFilters();
			});
		},


		@if (userData.Admin_Labels_CanAdd)
		{
		<text>
		CreateNewCard: function () {
			var self = this;
			var html = $(`
			<div class="new-item-card label-card">
				<div style="padding-top:10px;">
					<div class="btn btn-outline-secondary btn-sm" action="CreateItem" style="display:block; margin:auto; width:140px;"><span class="fa fa-plus"></span>&nbsp;&nbsp;@g["New Label"]</div>
				</div>
				<img action="CreateItem" src="/images/newitem.png" class="image-preview label-preview" style="margin-top:48px" />
			</div>`);
			AppContext.BindActions(html, this);
	        self.elements.ListContainer.append(html);
		},

        CreateItem: function (e) {
			var self = this;
            AppContext.LoadJS("/common/AskNameDialog.js").then(() => {
				var dialog = new AskNameDialog("@g["New Label"]");
				dialog.ShowDialog(function (dlgData) {
					if (dlgData) {
						dlgData.ProjectID = self.ProjectID;
                        AppContext.Labels.Insert(dlgData, function (result) {
							if (result.Success) {
								self.CreateItemCard(result.Data);
								self.dataSource.push(result.Data);
								var card = self.ViewContainer.find(`[data-entityid='${result.Data.ID}']`);
                                self.ItemSelected.Raise({ target: self, item: result.Data });
							}
						});
					}
				});
			})
		},
		</text>
		}


		@if (userData.Admin_Labels_CanDelete)
		{
		<text>
		DeleteItem: function (e) {
			var self = this;
			var card = $(e.target.parentNode);
			var id = card.attr("data-entityid");
			var confirm = new ConfirmDialog("@g["Delete Label? IMPORTANT: This operation cannot be undone."]");
			confirm.ShowDialog(function (response) {
				if (response) {
					AppContext.Labels.Delete(id, function (result) {
						if (result.Success) {
							card.off();
							card.remove();
                            var idx = self.dataSource.findIndex(function (e) { return e.ID == id; });
                            self.dataSource.splice(idx, 1);
						}
					});
				}
			});
		},
		</text>
		}


		CreateItemCard: function (data) {
			var self = this;
			var openAction = this.ShowOpenOption ? " action=OpenClicked" : " style='cursor:default;'";
			@if (userData.Admin_Labels_CanDelete)
			{
			@:var deleteAction = this.ShowDeleteOption ? '<span class="ti ti-close card-right card-close" action=DeleteItem></span>' : "";
			}
			else
			{
			@:var deleteAction = "";
			}
			var rfid = data.EncodeRFID == true ? "badge-warning" : "badge-secondary";
			var shared = data.ProjectID != null? "badge-secondary" : "badge-warning";
			var comments = data.Comments ? data.Comments : "";
			var html = $(`
			<div class="item-card label-card" data-entityid="${data.ID}"${openAction}>
				<span class="fa fa-object-group"></span>${deleteAction}
				<div style="cursor:pointer" name="Name" title="${data.Name}">${data.Name}</div>
				<div class="card-comment" name="Comments">${comments}</div>
				<span class="badge ${rfid}" name="RFFlag">RFID</span>
				<span class="badge ${shared}" name="SHFlag">Shared</span>
				<div class="preview-container"><img src="/labels/getpreview/${data.ID}?${new Date().getTime()}" class="image-preview label-preview" /></div>
			</div>`);
			AppContext.BindActions(html, this);
		    self.elements.ListContainer.append(html);
        },

        OpenClicked: function (e) {
			var self = this;
			e.preventDefault();
			var cardElm = $(e.target).closest("[data-entityid]");
			var id = cardElm.attr("data-entityid");
			var cardData = this.dataSource.first(p => p.ID == id);
			this.ItemSelected.Raise({ target: this, item: cardData });
		},

		UpdateCard: function (data) {
			var idx = this.dataSource.findIndex(p => p.ID == data.ID);
			if (idx >= 0) {
				this.dataSource[idx] = data;
				var card = this.ViewContainer.find(`[data-entityid='${data.ID}']`);
				card.find("[name='Name']").text(data.Name);
				card.find("[name='Comments']").text(data.Comments);
				var rfBadge = card.find("[name='RFFlag']");
				if (data.EncodeRFID) {
					rfBadge.removeClass("badge-secondary");
					rfBadge.addClass("badge-warning");
				}
				else {
					rfBadge.addClass("badge-secondary");
					rfBadge.removeClass("badge-warning");
				}
				var sharedBadge = card.find("[name='SHFlag']");
				if (data.ProjectID == null) {
					sharedBadge.removeClass("badge-secondary");
					sharedBadge.addClass("badge-warning");
				}
				else {
					sharedBadge.addClass("badge-secondary");
					sharedBadge.removeClass("badge-warning");
				}
				card.find(".label-preview").attr("src", `labels/getpreview/${data.ID}?${new Date().getTime()}`)
			}
		}
	};
//</script>