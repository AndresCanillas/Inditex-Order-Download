@page
@inject ILocalizationService g
@{
    Layout = null;
}

//# sourceURL=https://Pages/Orders/GetOrdersDialog.js
///<reference path="/js/jquery-3.0.0.min.js" />
///<reference path="/js/Kendo.all.min.js" />
///<reference path="/js/AppContext.js" />

//<script>
    var GetOrdersDialog = function () {
        FormView.Extend(this, "@g["Get Orders by Inditex API"]", "/Orders/GetOrdersDialog");
        this.elements = {
            orderNumber: null,
            campaignCode: null,
            vendorId: null,
            buttonGetOrder: null,
            orderNumberError: null,
            information2: null
        };
    };

    GetOrdersDialog.prototype = {
        constructor: GetOrdersDialog,

        OnLoad: function () {
            var self = this;
            [this.elements.orderNumber, this.elements.campaignCode, this.elements.vendorId].forEach(function (element) {
                element.keypress(function (e) {
                    if (e.which === 13) {
                        self.elements.buttonGetOrder.click();
                        e.preventDefault();
                    }
                });
            });
        },

        OnUnload: function () {
            // Limpiar listeners si es necesario
        },

        GetOrder: async function (selfOrEvent) {
            var self = selfOrEvent.data || this;

            var orderNumberInput = self.elements.orderNumber;
            var campaignCodeInput = self.elements.campaignCode;
            var vendorIdInput = self.elements.vendorId;
            var errorLabel = self.elements.orderNumberError;
            var output = self.elements.information2;

            var orderNumber = orderNumberInput.val().trim();
            var campaignCode = campaignCodeInput.val().trim();
            var vendorId = vendorIdInput.val().trim();

            if (typeof GetOrdersValidation === "undefined") {
                output.removeClass("alert-success alert-secondary d-none").addClass("alert-danger").text("@g["Validation resources are not available. Please reload the page."]");
                return;
            }

            var validation = GetOrdersValidation.validateInputs({
                orderNumber: orderNumber,
                campaignCode: campaignCode,
                vendorId: vendorId
            });

            campaignCode = validation.normalizedCampaignCode;
            campaignCodeInput.val(campaignCode);

            orderNumberInput.toggleClass("is-invalid", !validation.orderNumberValid);
            campaignCodeInput.toggleClass("is-invalid", !validation.campaignCodeValid);
            vendorIdInput.toggleClass("is-invalid", !validation.vendorIdValid);

            var messages = [];
            if (!validation.orderNumberValid) {
                messages.push(`@g["Please enter a valid order number (only numbers, 10 digits, no leading zero)."]`);
            }
            if (!validation.campaignCodeValid) {
                messages.push(`@g["Please enter a valid campaign (I, V, P, O + 2 last digits of year, example: I25)."]`);
            }
            if (!validation.vendorIdValid) {
                messages.push(`@g["Please enter a valid vendor id (only numbers, 5 to 10 digits)."]`);
            }

            if (messages.length > 0) {
                errorLabel.removeClass("d-none").html(messages.join("<br />"));
                output.removeClass("alert-success alert-danger").addClass("alert-warning").html(messages.join("<br />"));
                return;
            }

            errorLabel.addClass("d-none").text("");
            output.removeClass("alert-success alert-danger d-none").addClass("alert-secondary").html(`@g["Processing..."]`);


            try {
                const response = await AppContext.HttpPost("/order/get", {
                    OrderNumber: orderNumber,
                    CampaignCode: campaignCode,
                    VendorId: vendorId
                });
                const result = await response.json();

                const css = result.Success ? "alert-success" : "alert-danger";
                const formatted = result.Message
                    .split(/\r?\n|\r|<br\s*\/?>/g)
                    .filter(x => x.trim().length)
                    .map(x => `<li>${x.trim()}</li>`)
                    .join("");

                const htmlResult = `
                        <strong>@g["Order"]:</strong> ${orderNumber}<br />
                        <strong>@g["Result"]:</strong>
                        <ul class="mb-0">${formatted}</ul>
                    `;

                output.removeClass("alert-secondary").addClass(css).html(htmlResult);

            } catch (err) {
                console.error(err);
                output.removeClass("alert-success alert-secondary d-none").addClass("alert-danger").text("An error occurred while contacting the server.");
            }
        }
    };
//</script>
