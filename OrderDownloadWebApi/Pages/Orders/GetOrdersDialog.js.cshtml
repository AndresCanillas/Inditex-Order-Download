@page
@inject ILocalizationService g
@{
    Layout = null;
}

//# sourceURL=https://Pages/Orders/GetOrdersDialog.js
///<reference path="/js/jquery-3.0.0.min.js" />
///<reference path="/js/Kendo.all.min.js" />
///<reference path="/js/AppContext.js" />

//<script>
    var GetOrdersDialog = function () {
        FormView.Extend(this, "@g["Get Orders by Inditex API"]", "/Orders/GetOrdersDialog");
        this.elements = {
            orderNumber: null,
            campaignCode: null,
            vendorId: null,
            buttonGetOrder: null,
            orderNumberError: null,
            information2: null,
            processTrackerContainer: null,
            processTrackerToggle: null,
            processTrackerList: null
        };

        this.processSteps = [];
        this.requestState = null;
        this.currentOrderContext = null;
        this.handleRealtimeEventBound = null;
    };

    GetOrdersDialog.prototype = {
        constructor: GetOrdersDialog,

        OnLoad: function () {
            var self = this;
            if (typeof GetOrdersRequestState !== "undefined") {
                self.requestState = GetOrdersRequestState.createState(self.elements.buttonGetOrder);
            }
            [this.elements.orderNumber, this.elements.campaignCode, this.elements.vendorId].forEach(function (element) {
                element.keypress(function (e) {
                    if (e.which === 13) {
                        self.elements.buttonGetOrder.click();
                        e.preventDefault();
                    }
                });
            });

            this.initializeTracker();
            this.elements.processTrackerToggle.on("click", function () {
                self.toggleTracker();
            });

            if (typeof AppContext !== "undefined" && AppContext.AppEventListener && typeof AppContext.AppEventListener.Subscribe === "function") {
                this.handleRealtimeEventBound = function (eventData) {
                    self.handleRealtimeEvent(eventData);
                };
                AppContext.AppEventListener.Subscribe(this, this.handleRealtimeEventBound);
            }
        },

        OnUnload: function () {
            if (this.handleRealtimeEventBound && typeof AppContext !== "undefined" && AppContext.AppEventListener && typeof AppContext.AppEventListener.Unsubscribe === "function") {
                AppContext.AppEventListener.Unsubscribe(this, this.handleRealtimeEventBound);
                this.handleRealtimeEventBound = null;
            }
        },

        initializeTracker: function () {
            if (typeof GetOrderProcessTracker === "undefined") {
                return;
            }

            this.processSteps = GetOrderProcessTracker.buildDefaultSteps();
            this.renderTracker();
        },

        toggleTracker: function () {
            var toggle = this.elements.processTrackerToggle;
            var list = this.elements.processTrackerList;
            var expanded = toggle.attr("aria-expanded") === "true";

            toggle.attr("aria-expanded", (!expanded).toString());
            toggle.html((expanded ? "▼" : "▲") + " @g["See process phases"]");
            list.toggleClass("d-none", expanded);
        },

        renderTracker: function () {
            var self = this;
            var container = this.elements.processTrackerContainer;
            var list = this.elements.processTrackerList;

            if (!this.processSteps || this.processSteps.length === 0) {
                container.addClass("d-none");
                return;
            }

            container.removeClass("d-none");

            var html = this.processSteps.map(function (step) {
                return "<li class='order-process-tracker__item " + self.getItemStatusClass(step.status) + "'>"
                    + "<span class='order-process-tracker__badge " + self.getStatusClass(step.status) + "'>" + self.getStatusText(step.status) + "</span>"
                    + "<div class='order-process-tracker__content'>"
                    + "<strong>" + step.title + "</strong><br />"
                    + "<small>" + (step.detail || "") + "</small>"
                    + "</div>"
                    + "</li>";
            }).join("");

            list.html(html);
        },

        getStatusClass: function (status) {
            switch (status) {
                case "completed":
                    return "order-process-tracker__badge--completed";
                case "in-progress":
                    return "order-process-tracker__badge--in-progress";
                case "failed":
                    return "order-process-tracker__badge--failed";
                case "pending-validation":
                    return "order-process-tracker__badge--pending-validation";
                default:
                    return "order-process-tracker__badge--pending";
            }
        },


        getItemStatusClass: function (status) {
            switch (status) {
                case "completed":
                    return "order-process-tracker__item--completed";
                case "in-progress":
                    return "order-process-tracker__item--in-progress";
                case "failed":
                    return "order-process-tracker__item--failed";
                case "pending-validation":
                    return "order-process-tracker__item--pending-validation";
                default:
                    return "order-process-tracker__item--pending";
            }
        },

        getStatusText: function (status) {
            switch (status) {
                case "completed":
                    return "@g["Completed"]";
                case "in-progress":
                    return "@g["In progress"]";
                case "failed":
                    return "@g["Error"]";
                case "pending-validation":
                    return "@g["Pending validation"]";
                default:
                    return "@g["Pending"]";
            }
        },

        startWorkflowTracker: function () {
            if (typeof GetOrderProcessTracker === "undefined") {
                return;
            }

            this.processSteps = GetOrderProcessTracker.buildDefaultSteps();
            GetOrderProcessTracker.markStepInProgress(this.processSteps, "search-order", "@g["Searching order in queues..."]");
            this.renderTracker();

            this.elements.processTrackerToggle.attr("aria-expanded", "true").html("▲ @g["See process phases"]");
            this.elements.processTrackerList.removeClass("d-none");
        },

        updateTrackerForSuccess: function (resultMessage) {
            if (typeof GetOrderProcessTracker === "undefined") {
                return;
            }

            GetOrderProcessTracker.syncStepsFromMessage(this.processSteps, resultMessage);
            this.renderTracker();
        },


        handleRealtimeEvent: function (eventData) {
            if (typeof GetOrderProcessTracker === "undefined") {
                return;
            }

            if (!eventData || eventData.EventName !== "OrderGetProgressEvent") {
                return;
            }

            if (!this.currentOrderContext || !this.requestState || !this.requestState.isInProgress()) {
                return;
            }

            var data = eventData.Data || eventData.data || eventData;
            if (!data || !data.OrderNumber || data.OrderNumber !== this.currentOrderContext.orderNumber) {
                return;
            }

            if (GetOrderProcessTracker.applyProgressEvent(this.processSteps, data)) {
                this.renderTracker();
            }
        },

        updateTrackerForServerError: function (errorMessage) {
            if (typeof GetOrderProcessTracker === "undefined") {
                return;
            }

            var detail = errorMessage || "@g["Server communication error"]";
            GetOrderProcessTracker.syncStepsFromMessage(this.processSteps, detail);

            var failedStep = this.processSteps.find(function (step) { return step.status === GetOrderProcessTracker.STATUS.FAILED; });
            if (!failedStep) {
                var activeStep = this.processSteps.find(function (step) { return step.status === GetOrderProcessTracker.STATUS.IN_PROGRESS; });
                var stepId = activeStep ? activeStep.id : "search-order";
                GetOrderProcessTracker.failStep(this.processSteps, stepId, detail);
            }

            this.renderTracker();
        },

        GetOrder: async function (selfOrEvent) {
            var self = selfOrEvent.data || this;

            var orderNumberInput = self.elements.orderNumber;
            var campaignCodeInput = self.elements.campaignCode;
            var vendorIdInput = self.elements.vendorId;
            var errorLabel = self.elements.orderNumberError;
            var output = self.elements.information2;

            var orderNumber = orderNumberInput.val().trim();
            var campaignCode = campaignCodeInput.val().trim();
            var vendorId = vendorIdInput.val().trim();

            self.currentOrderContext = null;

            if (typeof GetOrdersValidation === "undefined") {
                output.removeClass("alert-success alert-secondary d-none").addClass("alert-danger").text("@g["Validation resources are not available. Please reload the page."]");
                return;
            }

            var validation = GetOrdersValidation.validateInputs({
                orderNumber: orderNumber,
                campaignCode: campaignCode,
                vendorId: vendorId
            });

            campaignCode = validation.normalizedCampaignCode;
            campaignCodeInput.val(campaignCode);

            orderNumberInput.toggleClass("is-invalid", !validation.orderNumberValid);
            campaignCodeInput.toggleClass("is-invalid", !validation.campaignCodeValid);
            vendorIdInput.toggleClass("is-invalid", !validation.vendorIdValid);

            var messages = [];
            if (!validation.orderNumberValid) {
                messages.push(`@g["Please enter a valid order number (only numbers, 5 to 10 digits, no leading zero)."]`);
            }
            if (!validation.campaignCodeValid) {
                messages.push(`@g["Please enter a valid campaign (I, V, P, O + 2 last digits of year, example: I25)."]`);
            }
            if (!validation.vendorIdValid) {
                messages.push(`@g["Please enter a valid vendor id (only numbers, 5 to 10 digits)."]`);
            }

            if (messages.length > 0) {
                errorLabel.removeClass("d-none").html(messages.join("<br />"));
                output.removeClass("alert-success alert-danger").addClass("alert-warning").html(messages.join("<br />"));
                return;
            }

            errorLabel.addClass("d-none").text("");
          
           if (self.requestState && !self.requestState.begin()) {
                return;
            }

            if (!self.requestState) {
                self.elements.buttonGetOrder.prop("disabled", true);
            }
            output.removeClass("alert-success alert-danger d-none").addClass("alert-secondary").html(`@g["Processing..."]`);
            self.currentOrderContext = {
                orderNumber: orderNumber,
                campaignCode: campaignCode,
                vendorId: vendorId
            };
            self.startWorkflowTracker();
           
            try {
                const response = await AppContext.HttpPost("/order/get", {
                    OrderNumber: orderNumber,
                    CampaignCode: campaignCode,
                    VendorId: vendorId
                });

                const parsedResponse = typeof GetOrdersApiResponse !== "undefined"
                    ? await GetOrdersApiResponse.parse(response)
                    : {
                        ok: response && response.Success === true,
                        result: response || null,
                        message: response && response.Message ? response.Message : ""
                    };

                const backendMessage = parsedResponse.message || "";
                const messageToShow = backendMessage || (parsedResponse.ok ? "@g["Operation completed"]" : "@g["Operation could not be completed."]");
                const isSuccess = !!(parsedResponse.result && parsedResponse.result.Success === true && parsedResponse.ok && !(typeof GetOrderProcessTracker !== "undefined" && GetOrderProcessTracker.messageContainsError(messageToShow)));

                if (isSuccess) {
                    self.updateTrackerForSuccess(messageToShow);
                } else {
                    self.updateTrackerForServerError(messageToShow);
                }

                const css = isSuccess ? "alert-success" : "alert-danger";
                const formatted = messageToShow
                    .split(/\r?\n|\r|<br\s*\/?>/g)
                    .filter(x => x.trim().length)
                    .map(x => `<li>${x.trim()}</li>`)
                    .join("");

                const htmlResult = `
                        <strong>@g["Order"]:</strong> ${orderNumber}<br />
                        <strong>@g["Result"]:</strong>
                        <ul class="mb-0">${formatted}</ul>
                    `;

                output.removeClass("alert-secondary").addClass(css).html(htmlResult);

            } catch (err) {
                console.error(err);
                self.updateTrackerForServerError("@g["Server communication error"]");
                output.removeClass("alert-success alert-secondary d-none").addClass("alert-danger").text("@g["Server communication error"]");
            } finally {
                self.currentOrderContext = null;

                if (self.requestState) {
                    self.requestState.end();
                } else {
                    self.elements.buttonGetOrder.prop("disabled", false);
                }
            }
        }
    };
//</script>
